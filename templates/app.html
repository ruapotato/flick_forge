<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="App details on Flick Store - Qt/QML apps for Flick">
  <meta name="theme-color" content="#0a0a0f">
  <title>App Details - Flick Store</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127919;</text></svg>">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="/" class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <span>Flick Store</span>
      </a>

      <nav class="nav" role="navigation" aria-label="Main navigation">
        <a href="/" class="nav-link">Home</a>
        <a href="/browse" class="nav-link">Browse</a>
        <a href="/wildwest" class="nav-link wild-west">Wild West</a>
        <a href="/request" class="nav-link">Request</a>
      </nav>

      <div class="header-actions">
        <div class="header-search">
          <svg class="header-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="search" placeholder="Search apps..." aria-label="Search apps" data-search>
        </div>

        <a href="/login" class="btn btn-ghost" data-guest>Sign In</a>
        <a href="/profile" class="btn btn-secondary" data-auth style="display:none">
          <span data-user-avatar>U</span>
        </a>
      </div>

      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <main class="app-detail">
    <div class="container">
      <!-- Loading State -->
      <div class="loading" id="app-loading">
        <div class="loading-spinner"></div>
      </div>

      <!-- App Header -->
      <div class="app-detail-header" id="app-header" style="display:none;">
        <div class="app-detail-icon" id="app-icon">&#128230;</div>

        <div class="app-detail-info">
          <h1 id="app-name">Loading...</h1>
          <p class="app-detail-developer">
            by <a href="#" id="app-developer">Flick</a>
          </p>

          <div class="app-detail-stats">
            <div class="app-stat">
              <div class="app-stat-value" id="app-rating">-</div>
              <div class="app-stat-label">Rating</div>
            </div>
            <div class="app-stat">
              <div class="app-stat-value" id="app-downloads">0</div>
              <div class="app-stat-label">Downloads</div>
            </div>
            <div class="app-stat">
              <div class="app-stat-value" id="app-category">-</div>
              <div class="app-stat-label">Category</div>
            </div>
            <div class="app-stat">
              <div class="app-stat-value" id="app-version">1.0.0</div>
              <div class="app-stat-label">Version</div>
            </div>
          </div>
        </div>

        <div class="app-detail-actions">
          <button class="btn btn-primary btn-lg" id="install-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7,10 12,15 17,10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Install
          </button>
          <button class="btn btn-secondary" data-modal-open="report-modal">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
              <line x1="4" y1="22" x2="4" y2="15"/>
            </svg>
            Report Issue
          </button>
        </div>
      </div>

      <!-- Description -->
      <div class="app-description" id="app-description" style="display:none;">
        <h2>About this app</h2>
        <p id="app-desc-text"></p>
        <div id="app-ai-notice" class="mt-md" style="display:none;padding:var(--space-md);background:var(--bg-tertiary);border-radius:var(--radius-md);border-left:3px solid var(--warning);">
          <strong>AI Generated:</strong> This app was created by AI based on a community request. Please test and provide feedback!
        </div>
      </div>

      <!-- Install Instructions -->
      <div class="install-box" id="install-box" style="display:none;">
        <h3>Installation</h3>
        <p class="text-secondary mb-md">Install using the Flick Store app or command line:</p>
        <div class="install-command">
          <code id="install-cmd">flick install app-slug</code>
          <button class="btn-copy" data-copy="#install-cmd" aria-label="Copy to clipboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Reviews Section -->
      <section class="reviews-section section" id="reviews-section" style="display:none;">
        <div class="reviews-header">
          <h2 class="section-title">Reviews</h2>
          <button class="btn btn-secondary" data-modal-open="review-modal" data-auth>Write a Review</button>
        </div>

        <div class="reviews-summary mb-xl">
          <div class="reviews-average">
            <div class="reviews-average-score" id="reviews-score">-</div>
            <div class="reviews-average-stars" id="reviews-stars"></div>
            <div class="reviews-average-count" id="reviews-count">0 reviews</div>
          </div>
        </div>

        <div id="reviews-list">
          <p class="text-muted" id="no-reviews">No reviews yet. Be the first to review this app!</p>
        </div>
      </section>

      <!-- Error State -->
      <div class="empty-state" id="app-error" style="display:none;">
        <div class="empty-state-icon">&#128533;</div>
        <h3>App Not Found</h3>
        <p>The app you're looking for doesn't exist or has been removed.</p>
        <a href="/browse" class="btn btn-primary">Browse Apps</a>
      </div>
    </div>
  </main>

  <!-- Report Issue Modal -->
  <div class="modal-overlay" id="report-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Report an Issue</h3>
        <button class="modal-close" data-modal-close aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="report-form">
          <div class="form-group">
            <label class="form-label" for="report-type">Issue Type</label>
            <select class="form-select" id="report-type" name="type" required>
              <option value="">Select an issue type</option>
              <option value="bug">Bug / Crash</option>
              <option value="suggestion">Suggestion</option>
              <option value="rebuild_request">Request Rebuild (AI apps)</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="report-description">Description</label>
            <textarea class="form-textarea" id="report-description" name="description"
                      placeholder="Please describe the issue in detail..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;">Submit Report</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Write Review Modal -->
  <div class="modal-overlay" id="review-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Write a Review</h3>
        <button class="modal-close" data-modal-close aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="review-form" data-app-slug="">
          <div class="form-group">
            <label class="form-label">Rating</label>
            <div class="rating-input" style="display:flex;gap:var(--space-sm);font-size:var(--text-2xl);">
              <label style="cursor:pointer;">
                <input type="radio" name="rating" value="1" class="sr-only">
                <span class="rating-star" data-rating="1">&#9734;</span>
              </label>
              <label style="cursor:pointer;">
                <input type="radio" name="rating" value="2" class="sr-only">
                <span class="rating-star" data-rating="2">&#9734;</span>
              </label>
              <label style="cursor:pointer;">
                <input type="radio" name="rating" value="3" class="sr-only">
                <span class="rating-star" data-rating="3">&#9734;</span>
              </label>
              <label style="cursor:pointer;">
                <input type="radio" name="rating" value="4" class="sr-only">
                <span class="rating-star" data-rating="4">&#9734;</span>
              </label>
              <label style="cursor:pointer;">
                <input type="radio" name="rating" value="5" class="sr-only" checked>
                <span class="rating-star" data-rating="5">&#9733;</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="review-title">Title (optional)</label>
            <input type="text" class="form-input" id="review-title" name="title" placeholder="Summary of your review">
          </div>
          <div class="form-group">
            <label class="form-label" for="review-content">Your Review</label>
            <textarea class="form-textarea" id="review-content" name="content"
                      placeholder="Share your experience with this app..."
                      data-maxlength="1000" required></textarea>
            <p class="form-char-count" data-counter-for="review-content">0/1000</p>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;">Submit Review</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-brand">
          <a href="/" class="logo">
            <div class="logo-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
              </svg>
            </div>
            <span>Flick Store</span>
          </a>
          <p>A fast, modern app store for Flick mobile shell.</p>
        </div>

        <div>
          <h4 class="footer-title">Explore</h4>
          <nav class="footer-links">
            <a href="/browse" class="footer-link">Browse Apps</a>
            <a href="/browse?category=games" class="footer-link">Games</a>
            <a href="/wildwest" class="footer-link">Wild West</a>
          </nav>
        </div>

        <div>
          <h4 class="footer-title">Community</h4>
          <nav class="footer-links">
            <a href="/request" class="footer-link">Request an App</a>
            <a href="https://github.com/ruapotato/Flick" class="footer-link">GitHub</a>
          </nav>
        </div>

        <div>
          <h4 class="footer-title">Resources</h4>
          <nav class="footer-links">
            <a href="/api" class="footer-link">API</a>
          </nav>
        </div>
      </div>

      <div class="footer-bottom">
        <p class="footer-copyright">&copy; 2025 Flick Project. AGPL-3.0 Licensed.</p>
      </div>
    </div>
  </footer>

  <script src="/static/js/api.js"></script>
  <script src="/static/js/main.js"></script>
  <script>
    // App icons mapping
    const appIcons = {
      'music': '&#127925;',
      'ebooks': '&#128214;',
      'audiobooks': '&#127911;',
      'sandbox': '&#127958;',
      'calculator': '&#129518;',
      'calendar': '&#128197;',
      'clock': '&#9200;',
      'contacts': '&#128101;',
      'files': '&#128193;',
      'notes': '&#128221;',
      'weather': '&#127780;',
      'photos': '&#128247;',
      'video': '&#127916;',
      'web': '&#127760;',
      'maps': '&#128506;',
      'podcast': '&#127897;',
      'recorder': '&#127908;',
      'terminal': '&#128187;',
      'settings': '&#9881;',
      'messages': '&#128172;',
      'phone': '&#128222;',
      'email': '&#128231;',
      'passwordsafe': '&#128274;',
      'distract': '&#127918;',
      'welcome': '&#128075;',
      'store': '&#127919;',
    };

    const categoryIcons = {
      'multimedia': '&#127925;',
      'productivity': '&#128221;',
      'games': '&#127918;',
      'utilities': '&#128295;',
      'internet': '&#127760;',
      'communication': '&#128172;',
      'development': '&#128187;',
      'security': '&#128274;',
      'system': '&#9881;',
    };

    function getAppIcon(slug, category) {
      return appIcons[slug] || categoryIcons[category] || '&#128230;';
    }

    function formatDownloads(count) {
      if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
      if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
      return count.toString();
    }

    function formatCategoryName(name) {
      if (!name) return '';
      return name.charAt(0).toUpperCase() + name.slice(1).replace(/-/g, ' ');
    }

    function renderStars(rating) {
      const fullStars = Math.floor(rating);
      const hasHalf = rating % 1 >= 0.5;
      let stars = '';
      for (let i = 0; i < 5; i++) {
        if (i < fullStars) stars += '&#9733;';
        else stars += '&#9734;';
      }
      return stars;
    }

    // Rating star interaction
    document.querySelectorAll('.rating-star').forEach(star => {
      star.addEventListener('click', function() {
        const rating = parseInt(this.dataset.rating);
        document.querySelectorAll('.rating-star').forEach((s, i) => {
          s.innerHTML = i < rating ? '&#9733;' : '&#9734;';
          s.style.color = i < rating ? 'var(--warning)' : 'var(--text-muted)';
        });
      });
    });

    // Get slug from URL path: /app/music -> music
    function getSlugFromPath() {
      const path = window.location.pathname;
      const match = path.match(/\/app\/([^\/]+)/);
      return match ? match[1] : null;
    }

    // Load app data
    document.addEventListener('DOMContentLoaded', async () => {
      const slug = getSlugFromPath() || '{{ slug }}';
      const loadingEl = document.getElementById('app-loading');
      const headerEl = document.getElementById('app-header');
      const descEl = document.getElementById('app-description');
      const installEl = document.getElementById('install-box');
      const reviewsEl = document.getElementById('reviews-section');
      const errorEl = document.getElementById('app-error');

      if (!slug) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        return;
      }

      try {
        const data = await API.get(`/apps/${slug}`);
        const app = data.app;

        if (!app) {
          throw new Error('App not found');
        }

        // Update page title
        document.title = `${app.name} - Flick Store`;

        // Update header
        document.getElementById('app-icon').innerHTML = getAppIcon(app.slug, app.category);
        document.getElementById('app-name').textContent = app.name;
        document.getElementById('app-developer').textContent = app.author || 'Flick';
        document.getElementById('app-rating').textContent = app.average_rating ? app.average_rating.toFixed(1) : '-';
        document.getElementById('app-downloads').textContent = formatDownloads(app.download_count);
        document.getElementById('app-category').textContent = formatCategoryName(app.category);
        document.getElementById('app-version').textContent = app.version || '1.0.0';

        // Update description
        document.getElementById('app-desc-text').textContent = app.description;
        if (app.ai_generated) {
          document.getElementById('app-ai-notice').style.display = 'block';
        }

        // Update install command
        document.getElementById('install-cmd').textContent = `flick install ${app.slug}`;

        // Update reviews section
        document.getElementById('reviews-score').textContent = app.average_rating ? app.average_rating.toFixed(1) : '-';
        document.getElementById('reviews-stars').innerHTML = app.average_rating ? renderStars(app.average_rating) : '';
        document.getElementById('reviews-count').textContent = `${app.review_count || 0} reviews`;

        // Set slug for review form
        document.getElementById('review-form').dataset.appSlug = app.slug;

        // Load reviews
        await loadReviews(app.slug);

        // Show content
        loadingEl.style.display = 'none';
        headerEl.style.display = 'flex';
        descEl.style.display = 'block';
        installEl.style.display = 'block';
        reviewsEl.style.display = 'block';

      } catch (error) {
        console.error('Failed to load app:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
      }
    });

    async function loadReviews(slug) {
      try {
        const data = await API.get(`/reviews/app/${slug}`);
        const reviews = data.reviews || [];
        const reviewsList = document.getElementById('reviews-list');
        const noReviews = document.getElementById('no-reviews');

        if (reviews.length > 0) {
          noReviews.style.display = 'none';
          reviewsList.innerHTML = reviews.map(review => `
            <div class="review-card">
              <div class="review-header">
                <div class="review-avatar">${(review.author || 'A').charAt(0).toUpperCase()}</div>
                <div class="review-meta">
                  <span class="review-author">${escapeHtml(review.author || 'Anonymous')}</span>
                  <span class="review-date">${new Date(review.created_at).toLocaleDateString()}</span>
                </div>
                <div class="review-rating" style="color:var(--warning);">${renderStars(review.rating)}</div>
              </div>
              ${review.title ? `<h4 class="review-title">${escapeHtml(review.title)}</h4>` : ''}
              <p class="review-content">${escapeHtml(review.content || '')}</p>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Failed to load reviews:', error);
      }
    }

    // Handle review form submission
    document.getElementById('review-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const slug = form.dataset.appSlug;
      const rating = form.querySelector('input[name="rating"]:checked')?.value || 5;
      const title = form.querySelector('#review-title').value;
      const content = form.querySelector('#review-content').value;

      try {
        await API.post(`/reviews/app/${slug}`, { rating: parseInt(rating), title, content });
        alert('Review submitted successfully!');
        closeModal('review-modal');
        location.reload();
      } catch (error) {
        alert('Failed to submit review: ' + (error.message || 'Please try again'));
      }
    });

    // Handle report form submission
    document.getElementById('report-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const slug = getSlugFromPath();
      const type = document.getElementById('report-type').value;
      const content = document.getElementById('report-description').value;

      try {
        await API.post(`/feedback/app/${slug}`, {
          feedback_type: type,
          title: `${type} report`,
          content
        });
        alert('Report submitted successfully!');
        closeModal('report-modal');
      } catch (error) {
        alert('Failed to submit report: ' + (error.message || 'Please try again'));
      }
    });

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Copy button
    document.querySelector('.btn-copy')?.addEventListener('click', async () => {
      const cmd = document.getElementById('install-cmd').textContent;
      try {
        await navigator.clipboard.writeText(cmd);
        alert('Copied to clipboard!');
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  </script>
</body>
</html>
