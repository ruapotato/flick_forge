<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Your Profile - Flick Store">
  <meta name="theme-color" content="#0a0a0f">
  <title>My Profile - Flick Store</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127919;</text></svg>">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="/" class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <span>Flick Store</span>
      </a>

      <nav class="nav" role="navigation" aria-label="Main navigation">
        <a href="/" class="nav-link">Home</a>
        <a href="/browse" class="nav-link">Browse</a>
        <a href="/wildwest" class="nav-link wild-west">Wild West</a>
        <a href="/request" class="nav-link">Request</a>
      </nav>

      <div class="header-actions">
        <button class="btn btn-ghost" id="logout-btn" data-auth style="display:none;">Sign Out</button>
        <a href="/login" class="btn btn-ghost" data-guest>Sign In</a>
      </div>

      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Loading State -->
      <div id="profile-loading" class="text-center" style="padding:var(--space-3xl);">
        <div class="loading-spinner"></div>
        <p class="text-muted" style="margin-top:var(--space-md);">Loading profile...</p>
      </div>

      <!-- Not Logged In -->
      <div id="profile-guest" style="display:none;">
        <div class="text-center" style="padding:var(--space-3xl);">
          <h1 style="margin-bottom:var(--space-md);">Sign In Required</h1>
          <p class="text-secondary" style="margin-bottom:var(--space-lg);">
            Please sign in to view your profile.
          </p>
          <a href="/login?redirect=/profile" class="btn btn-primary btn-lg">Sign In</a>
        </div>
      </div>

      <!-- Profile Content -->
      <div id="profile-content" style="display:none;">
        <!-- Profile Header -->
        <div class="profile-header">
          <div class="profile-avatar" id="user-avatar">?</div>
          <div class="profile-info">
            <h1 id="user-name">Loading...</h1>
            <span class="profile-tier" id="user-tier">Member</span>
            <p class="text-secondary" id="user-joined">Member since ...</p>
          </div>
          <button class="btn btn-ghost text-error" id="header-logout-btn">
            Sign Out
          </button>
        </div>

        <!-- Profile Tabs -->
        <div class="profile-tabs">
          <button class="profile-tab active" data-tab="overview">Overview</button>
          <button class="profile-tab" data-tab="review" id="tab-btn-review" style="display:none;">Review Requests</button>
          <button class="profile-tab" data-tab="users" id="tab-btn-users" style="display:none;">Manage Users</button>
          <button class="profile-tab" data-tab="requests" id="tab-btn-requests">My Requests</button>
          <button class="profile-tab" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Content: Overview -->
        <div class="profile-tab-content" id="tab-overview">
          <section class="section">
            <div class="grid grid-2">
              <div class="card" style="padding:var(--space-lg);">
                <h3 style="font-size:var(--text-base);margin-bottom:var(--space-md);">Account Tier</h3>
                <div style="display:flex;align-items:center;gap:var(--space-md);">
                  <div style="width:48px;height:48px;background:var(--accent-subtle);border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;">
                    <span style="font-size:1.5rem;" id="tier-icon">&#128100;</span>
                  </div>
                  <div>
                    <div style="font-weight:600;color:var(--accent);" id="tier-name">Member</div>
                    <div class="text-sm text-muted" id="tier-desc">Standard account</div>
                  </div>
                </div>
              </div>

              <div class="card" style="padding:var(--space-lg);">
                <h3 style="font-size:var(--text-base);margin-bottom:var(--space-md);">Account Info</h3>
                <div style="display:flex;align-items:center;gap:var(--space-md);">
                  <div style="width:48px;height:48px;background:rgba(74, 222, 128, 0.1);border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;">
                    <span style="font-size:1.5rem;">&#128231;</span>
                  </div>
                  <div>
                    <div style="font-weight:600;color:var(--success);" id="user-email">...</div>
                    <div class="text-sm text-muted">Email address</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Admin Panel Link - shown for promoted/admin users -->
            <div class="card" id="admin-panel-card" style="padding:var(--space-lg);display:none;">
              <h3 style="font-size:var(--text-base);margin-bottom:var(--space-md);">Admin Tools</h3>
              <a href="/admin" class="btn btn-primary" style="width:100%;">
                Open Admin Panel
              </a>
              <p class="text-sm text-muted" style="margin-top:var(--space-sm);">
                Manage requests, users, and apps
              </p>
            </div>
          </section>

          <section class="section">
            <h2 class="section-title mb-lg">Getting Started</h2>
            <div class="card" style="padding:var(--space-xl);">
              <p class="text-secondary" style="margin-bottom:var(--space-md);">
                Welcome to Flick Store! Here's what you can do:
              </p>
              <ul style="color:var(--text-secondary);padding-left:var(--space-lg);">
                <li style="margin-bottom:var(--space-sm);"><a href="/browse" style="color:var(--accent);">Browse</a> Qt/QML apps for your Flick device</li>
                <li style="margin-bottom:var(--space-sm);"><a href="/request" style="color:var(--accent);">Request</a> new apps to be built by AI</li>
                <li style="margin-bottom:var(--space-sm);"><a href="/wildwest" style="color:var(--accent);">Test</a> experimental apps in Wild West</li>
              </ul>
            </div>
          </section>
        </div>

        <!-- Tab Content: Review Requests (promoted+ users) -->
        <div class="profile-tab-content" id="tab-review" style="display:none;">
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">Pending Requests</h2>
              <p class="text-secondary">Review and approve app requests for building</p>
            </div>

            <div id="review-loading" class="text-center" style="padding:var(--space-2xl);">
              <div class="loading-spinner"></div>
              <p class="text-secondary">Loading pending requests...</p>
            </div>

            <div id="review-empty" style="display:none;padding:var(--space-2xl);text-align:center;">
              <p class="text-secondary">No pending requests to review.</p>
            </div>

            <div id="review-list" style="display:none;">
            </div>
          </section>
        </div>

        <!-- Tab Content: Manage Users (admin only) -->
        <div class="profile-tab-content" id="tab-users" style="display:none;">
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">User Management</h2>
            </div>

            <div class="browse-controls mb-lg">
              <input type="search" id="users-search-input" class="form-input" placeholder="Search users..." style="max-width:300px;">
              <select id="users-tier-select" class="sort-select">
                <option value="">All Tiers</option>
                <option value="anonymous">Anonymous</option>
                <option value="limited">Limited</option>
                <option value="promoted">Promoted</option>
                <option value="admin">Admin</option>
              </select>
              <button class="btn btn-secondary" onclick="loadUsersAdmin()">Search</button>
            </div>

            <div id="users-loading" class="text-center" style="padding:var(--space-2xl);">
              <div class="loading-spinner"></div>
              <p class="text-secondary">Loading users...</p>
            </div>

            <div id="users-empty" style="display:none;padding:var(--space-2xl);text-align:center;">
              <p class="text-secondary">No users found.</p>
            </div>

            <div id="users-list" style="display:none;">
            </div>
          </section>
        </div>

        <!-- Tab Content: My Requests -->
        <div class="profile-tab-content" id="tab-requests" style="display:none;">
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">My Requests</h2>
              <a href="/request" class="btn btn-primary">New Request</a>
            </div>

            <div id="my-requests-list">
              <div class="loading" id="requests-loading">
                <div class="loading-spinner"></div>
              </div>
              <p class="text-muted text-center" id="no-requests" style="display:none;">
                You haven't submitted any requests yet. <a href="/request" style="color:var(--accent);">Submit your first request!</a>
              </p>
            </div>
          </section>
        </div>

        <!-- Tab Content: Settings -->
        <div class="profile-tab-content" id="tab-settings" style="display:none;">
          <section class="section">
            <h2 class="section-title mb-lg">Account Settings</h2>

            <div class="card" style="padding:var(--space-xl);margin-bottom:var(--space-lg);">
              <h3 style="margin-bottom:var(--space-lg);">Change Password</h3>
              <form id="password-form">
                <div class="form-group">
                  <label class="form-label" for="current-password">Current Password</label>
                  <input type="password" class="form-input" id="current-password" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="new-password">New Password</label>
                  <input type="password" class="form-input" id="new-password" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="confirm-new-password">Confirm New Password</label>
                  <input type="password" class="form-input" id="confirm-new-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Update Password</button>
              </form>
            </div>

            <div class="card" style="padding:var(--space-xl);border:1px solid var(--error);">
              <h3 style="color:var(--error);margin-bottom:var(--space-md);">Danger Zone</h3>
              <p class="text-secondary" style="margin-bottom:var(--space-md);">
                Once you sign out, you'll need to log in again to access your account.
              </p>
              <button class="btn btn-ghost text-error" id="settings-logout-btn">Sign Out</button>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-brand">
          <a href="/" class="logo">
            <div class="logo-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
              </svg>
            </div>
            <span>Flick Store</span>
          </a>
          <p>A fast, modern, community-driven app store for Linux.</p>
        </div>

        <div>
          <h4 class="footer-title">Explore</h4>
          <nav class="footer-links">
            <a href="/browse" class="footer-link">Browse Apps</a>
            <a href="/browse?category=games" class="footer-link">Games</a>
            <a href="/wildwest" class="footer-link">Wild West</a>
          </nav>
        </div>

        <div>
          <h4 class="footer-title">Community</h4>
          <nav class="footer-links">
            <a href="/request" class="footer-link">Request an App</a>
            <a href="https://github.com/ruapotato/Flick" class="footer-link">GitHub</a>
          </nav>
        </div>

        <div>
          <h4 class="footer-title">Resources</h4>
          <nav class="footer-links">
            <a href="/docs" class="footer-link">Documentation</a>
            <a href="/api" class="footer-link">API</a>
            <a href="/privacy" class="footer-link">Privacy</a>
          </nav>
        </div>
      </div>

      <div class="footer-bottom">
        <p class="footer-copyright">&copy; 2025 Flick Store. All apps AGPL-3.0 licensed. AI-generated with a human in the loop.</p>
      </div>
    </div>
  </footer>

  <script src="/static/js/api.js"></script>
  <script src="/static/js/main.js"></script>
  <script>
    // Profile page logic
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingEl = document.getElementById('profile-loading');
      const guestEl = document.getElementById('profile-guest');
      const contentEl = document.getElementById('profile-content');

      try {
        const data = await API.auth.getCurrentUser();

        if (data && data.authenticated && data.user) {
          const user = data.user;

          // Update UI with user data
          document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();
          document.getElementById('user-name').textContent = user.username;
          document.getElementById('user-tier').textContent = user.tier || 'Member';
          document.getElementById('user-email').textContent = user.email || 'Not set';

          // Format join date
          if (user.created_at) {
            const date = new Date(user.created_at);
            document.getElementById('user-joined').textContent =
              'Member since ' + date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
          }

          // Set tier info
          const tierInfo = {
            'anonymous': { icon: '&#128100;', name: 'Anonymous', desc: 'Can browse and install apps' },
            'limited': { icon: '&#11088;', name: 'Limited', desc: 'Can submit app requests' },
            'promoted': { icon: '&#128142;', name: 'Promoted', desc: 'Can approve requests' },
            'admin': { icon: '&#128081;', name: 'Admin', desc: 'Full admin access' }
          };

          const tierKey = (user.tier_name || 'anonymous').toString().toLowerCase();
          const tier = tierInfo[tierKey] || tierInfo['anonymous'];
          document.getElementById('tier-icon').innerHTML = tier.icon;
          document.getElementById('tier-name').textContent = tier.name;
          document.getElementById('tier-desc').textContent = tier.desc;

          // Show/hide tabs based on user tier
          if (user.tier >= 2) {
            // Promoted+ can review requests
            document.getElementById('tab-btn-review').style.display = '';
            document.getElementById('admin-panel-card').style.display = 'block';
          }
          if (user.tier >= 3) {
            // Admin can manage users
            document.getElementById('tab-btn-users').style.display = '';
          }

          // Store tier for later use
          window.currentUserTier = user.tier;

          // Show content
          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';

          // Load user's requests (if they can submit them)
          if (user.tier >= 1) {
            loadMyRequests();
          }
        } else if (data && data.authenticated === false) {
          // Explicitly not logged in
          loadingEl.style.display = 'none';
          guestEl.style.display = 'block';
        } else {
          // Unknown response, retry after short delay
          setTimeout(() => window.location.reload(), 1000);
        }
      } catch (error) {
        console.error('Profile auth error:', error);
        // Check if it's a rate limit or network error - retry
        if (error.message && (error.message.includes('rate') || error.message.includes('Too many'))) {
          loadingEl.innerHTML = '<p class="text-muted">Too many requests. Retrying...</p>';
          setTimeout(() => window.location.reload(), 2000);
        } else {
          // Actual auth failure
          loadingEl.style.display = 'none';
          guestEl.style.display = 'block';
        }
      }

      // Tab switching
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.profile-tab-content').forEach(c => c.style.display = 'none');

          tab.classList.add('active');
          const tabName = tab.dataset.tab;
          document.getElementById('tab-' + tabName).style.display = 'block';

          // Load data for specific tabs
          if (tabName === 'review' && window.currentUserTier >= 2) {
            loadPendingReview();
          } else if (tabName === 'users' && window.currentUserTier >= 3) {
            loadUsersAdmin();
          }
        });
      });

      // Logout buttons
      ['logout-btn', 'header-logout-btn', 'settings-logout-btn'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('click', async () => {
            try {
              await API.auth.logout();
              window.location.href = '/';
            } catch (error) {
              window.location.href = '/';
            }
          });
        }
      });

      // Password form
      const passwordForm = document.getElementById('password-form');
      if (passwordForm) {
        passwordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const currentPassword = document.getElementById('current-password').value;
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-new-password').value;

          if (newPassword !== confirmPassword) {
            showToast('Passwords do not match', 'error');
            return;
          }

          try {
            await API.auth.changePassword(currentPassword, newPassword);
            showToast('Password updated successfully', 'success');
            passwordForm.reset();
          } catch (error) {
            showToast(error.message || 'Failed to update password', 'error');
          }
        });
      }
    });

    async function loadMyRequests() {
      const listEl = document.getElementById('my-requests-list');
      const loadingEl = document.getElementById('requests-loading');
      const noRequestsEl = document.getElementById('no-requests');

      try {
        const data = await API.get('/requests/my-requests');
        loadingEl.style.display = 'none';

        if (!data.requests || data.requests.length === 0) {
          noRequestsEl.style.display = 'block';
          return;
        }

        const html = data.requests.map(req => `
          <div class="request-card">
            <div class="request-votes">
              <span class="request-vote-count">${req.upvotes || 0}</span>
            </div>
            <div class="request-content">
              <h3>${escapeHtml(req.title)}</h3>
              <p>${escapeHtml(req.prompt ? req.prompt.substring(0, 150) + '...' : '')}</p>
              <div class="request-meta">
                <span>Category: ${req.category || 'other'}</span>
              </div>
            </div>
            <span class="request-status status-${req.status}">${req.status}</span>
          </div>
        `).join('');

        listEl.innerHTML = html;
      } catch (error) {
        loadingEl.style.display = 'none';
        noRequestsEl.style.display = 'block';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load pending requests for review (promoted+ users)
    async function loadPendingReview() {
      const loadingEl = document.getElementById('review-loading');
      const emptyEl = document.getElementById('review-empty');
      const listEl = document.getElementById('review-list');

      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      listEl.style.display = 'none';

      try {
        const data = await API.get('/admin/requests/pending');
        loadingEl.style.display = 'none';

        if (!data.requests || data.requests.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }

        const html = data.requests.map(req => `
          <div class="card" style="padding:var(--space-lg);margin-bottom:var(--space-md);" id="review-request-${req.id}">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:var(--space-md);">
              <div style="flex:1;">
                <h3 style="margin-bottom:var(--space-sm);">${escapeHtml(req.title)}</h3>
                <p class="text-secondary" style="margin-bottom:var(--space-md);">${escapeHtml(req.prompt || '')}</p>
                <div class="text-sm text-muted">
                  <span>Category: ${req.category || 'other'}</span>
                  <span style="margin-left:var(--space-md);">By: ${escapeHtml(req.user?.username || 'Unknown')}</span>
                  <span style="margin-left:var(--space-md);">Votes: ${req.upvotes || 0}</span>
                </div>
              </div>
              <div style="display:flex;gap:var(--space-sm);">
                <button class="btn btn-primary" onclick="approveRequest(${req.id})">Approve</button>
                <button class="btn btn-ghost text-error" onclick="showRejectModal(${req.id})">Reject</button>
              </div>
            </div>
          </div>
        `).join('');

        listEl.innerHTML = html;
        listEl.style.display = 'block';
      } catch (error) {
        loadingEl.style.display = 'none';
        emptyEl.innerHTML = '<p class="text-error">Failed to load pending requests.</p>';
        emptyEl.style.display = 'block';
      }
    }

    async function approveRequest(requestId) {
      try {
        await API.post(`/admin/requests/${requestId}/approve`);
        showToast('Request approved! It will be built by AI.', 'success');
        document.getElementById(`review-request-${requestId}`).remove();

        // Check if list is now empty
        const listEl = document.getElementById('review-list');
        if (!listEl.children.length) {
          listEl.style.display = 'none';
          document.getElementById('review-empty').style.display = 'block';
        }
      } catch (error) {
        showToast(error.message || 'Failed to approve request', 'error');
      }
    }

    let rejectingRequestId = null;

    function showRejectModal(requestId) {
      rejectingRequestId = requestId;
      const modal = document.createElement('div');
      modal.id = 'reject-modal';
      modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;">
          <div class="card" style="padding:var(--space-xl);max-width:400px;width:90%;">
            <h3 style="margin-bottom:var(--space-md);">Reject Request</h3>
            <div class="form-group">
              <label class="form-label">Reason (optional)</label>
              <textarea id="reject-reason" class="form-input" rows="3" placeholder="Why is this request being rejected?"></textarea>
            </div>
            <div style="display:flex;gap:var(--space-sm);justify-content:flex-end;">
              <button class="btn btn-ghost" onclick="closeRejectModal()">Cancel</button>
              <button class="btn btn-primary" style="background:var(--error);" onclick="confirmReject()">Reject</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeRejectModal() {
      const modal = document.getElementById('reject-modal');
      if (modal) modal.remove();
      rejectingRequestId = null;
    }

    async function confirmReject() {
      if (!rejectingRequestId) return;

      const reason = document.getElementById('reject-reason')?.value || '';
      try {
        await API.post(`/admin/requests/${rejectingRequestId}/reject`, { reason });
        showToast('Request rejected', 'success');
        closeRejectModal();
        document.getElementById(`review-request-${rejectingRequestId}`).remove();

        // Check if list is now empty
        const listEl = document.getElementById('review-list');
        if (!listEl.children.length) {
          listEl.style.display = 'none';
          document.getElementById('review-empty').style.display = 'block';
        }
      } catch (error) {
        showToast(error.message || 'Failed to reject request', 'error');
      }
    }

    // Load users for admin management
    async function loadUsersAdmin() {
      const loadingEl = document.getElementById('users-loading');
      const emptyEl = document.getElementById('users-empty');
      const listEl = document.getElementById('users-list');

      const searchQuery = document.getElementById('users-search-input')?.value || '';
      const tierFilter = document.getElementById('users-tier-select')?.value || '';

      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      listEl.style.display = 'none';

      try {
        const params = {};
        if (searchQuery) params.search = searchQuery;
        if (tierFilter) params.tier = tierFilter;

        const data = await API.get('/admin/users', params);
        loadingEl.style.display = 'none';

        if (!data.users || data.users.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }

        const tierOptions = ['anonymous', 'limited', 'promoted', 'admin'];
        const html = data.users.map(user => `
          <div class="card" style="padding:var(--space-md);margin-bottom:var(--space-sm);display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${escapeHtml(user.username)}</strong>
              <span class="text-muted" style="margin-left:var(--space-sm);">${escapeHtml(user.email || '')}</span>
            </div>
            <div style="display:flex;align-items:center;gap:var(--space-sm);">
              <select class="sort-select" onchange="updateUserTier(${user.id}, this.value)" ${user.tier_name === 'admin' ? 'disabled' : ''}>
                ${tierOptions.map(t => `<option value="${t}" ${user.tier_name === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('')}
              </select>
            </div>
          </div>
        `).join('');

        listEl.innerHTML = html;
        listEl.style.display = 'block';
      } catch (error) {
        loadingEl.style.display = 'none';
        emptyEl.innerHTML = '<p class="text-error">Failed to load users.</p>';
        emptyEl.style.display = 'block';
      }
    }

    async function updateUserTier(userId, newTier) {
      try {
        await API.put(`/admin/users/${userId}/tier`, { tier: newTier });
        showToast(`User tier updated to ${newTier}`, 'success');
      } catch (error) {
        showToast(error.message || 'Failed to update user tier', 'error');
        loadUsersAdmin(); // Reload to reset select
      }
    }
  </script>
</body>
</html>
